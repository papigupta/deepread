<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Depth Target Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .container {
            background-color: #f5f5f5;
            padding: 20px;
            border-radius: 10px;
        }
        h1 {
            color: #333;
        }
        input {
            padding: 10px;
            width: 70%;
            margin-right: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        button {
            padding: 10px 15px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background-color: #45a049;
        }
        .loading {
            margin-top: 20px;
            color: #666;
        }
        .concept {
            background-color: #fff;
            padding: 10px;
            margin: 5px 0;
            border-radius: 4px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .depth-badge {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            color: #333;
        }
        .error {
            color: red;
            margin-top: 10px;
        }
        .step {
            background-color: #e9f7ef;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }
        #debug {
            background-color: #ffe6cc;
            padding: 10px;
            margin-top: 20px;
            border-radius: 5px;
            font-family: monospace;
            white-space: pre-wrap;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Depth Target Test</h1>
        
        <div class="step">
            <h3>Step 1: Extract Concepts</h3>
            <div>
                <input type="text" id="bookInput" placeholder="Enter book name...">
                <button id="extractBtn">Extract Concepts</button>
            </div>
            <div id="loadingConcepts" class="loading" style="display: none;">Loading concepts...</div>
        </div>
        
        <div class="step">
            <h3>Step 2: Assign Depth Targets</h3>
            <button id="assignDepthBtn" disabled>Assign Depth Targets</button>
            <div id="loadingDepth" class="loading" style="display: none;">Assigning depth targets...</div>
        </div>
        
        <div id="error" class="error" style="display: none;"></div>
        
        <div id="conceptsContainer" style="margin-top: 20px;">
            <h2 id="conceptsTitle" style="display: none;">Extracted Concepts:</h2>
            <div id="concepts"></div>
            <p id="source" style="font-style: italic; color: #666; font-size: 12px;"></p>
        </div>
        
        <div id="depthContainer" style="margin-top: 20px;">
            <h2 id="depthTitle" style="display: none;">Concepts with Depth Targets:</h2>
            <div id="conceptsWithDepth"></div>
            <p id="depthSource" style="font-style: italic; color: #666; font-size: 12px;"></p>
        </div>
        
        <div id="debug"></div>
    </div>

    <script>
        const API_URL = 'http://localhost:3000';
        let extractedConcepts = [];
        let bookName = '';
        
        // Helper to get depth color
        function getDepthColor(depth) {
            const colors = {
                1: '#E0F7FA', // Light blue - Recall
                2: '#B2EBF2', // Cyan - Reframe
                3: '#80DEEA', // Teal - Apply
                4: '#4DD0E1', // Darker teal - Contrast
                5: '#26C6DA', // Blue - Critique
                6: '#00BCD4'  // Dark blue - Remix
            };
            return colors[depth] || '#F5F5F5';
        }
        
        // Log to debug area
        function log(message, data) {
            const debug = document.getElementById('debug');
            const time = new Date().toLocaleTimeString();
            
            if (data) {
                const dataStr = typeof data === 'object' ? JSON.stringify(data, null, 2) : data;
                debug.innerHTML += `[${time}] ${message}\n${dataStr}\n\n`;
            } else {
                debug.innerHTML += `[${time}] ${message}\n\n`;
            }
            
            // Scroll to bottom
            debug.scrollTop = debug.scrollHeight;
        }

        // Extract concepts
        document.getElementById('extractBtn').addEventListener('click', async () => {
            bookName = document.getElementById('bookInput').value.trim();
            
            if (!bookName) {
                showError('Please enter a book name');
                return;
            }
            
            // Reset UI
            document.getElementById('loadingConcepts').style.display = 'block';
            document.getElementById('error').style.display = 'none';
            document.getElementById('conceptsTitle').style.display = 'none';
            document.getElementById('concepts').innerHTML = '';
            document.getElementById('source').textContent = '';
            document.getElementById('depthTitle').style.display = 'none';
            document.getElementById('conceptsWithDepth').innerHTML = '';
            document.getElementById('depthSource').textContent = '';
            document.getElementById('assignDepthBtn').disabled = true;
            
            log(`Extracting concepts for book: "${bookName}"`);
            
            try {
                const response = await fetch(`${API_URL}/extract-concepts`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ bookName })
                });
                
                if (!response.ok) {
                    throw new Error(`Server error: ${response.status}`);
                }
                
                const data = await response.json();
                log('Received concept extraction response', data);
                
                if (!data.concepts || data.concepts.length === 0) {
                    showError('No concepts found for this book');
                    return;
                }
                
                extractedConcepts = data.concepts;
                
                // Display concepts
                document.getElementById('conceptsTitle').style.display = 'block';
                const conceptsContainer = document.getElementById('concepts');
                
                extractedConcepts.forEach(concept => {
                    const div = document.createElement('div');
                    div.className = 'concept';
                    div.textContent = concept;
                    conceptsContainer.appendChild(div);
                });
                
                // Show source
                document.getElementById('source').textContent = `Source: ${data.source || 'unknown'}`;
                
                // Enable depth target button
                document.getElementById('assignDepthBtn').disabled = false;
                
                log(`Extracted ${extractedConcepts.length} concepts`);
            } catch (error) {
                showError(`Error: ${error.message}`);
                log('Error fetching concepts:', error.message);
            } finally {
                document.getElementById('loadingConcepts').style.display = 'none';
            }
        });
        
        // Assign depth targets
        document.getElementById('assignDepthBtn').addEventListener('click', async () => {
            if (!extractedConcepts.length || !bookName) {
                showError('No concepts to assign depth targets to');
                return;
            }
            
            // Reset depth section
            document.getElementById('loadingDepth').style.display = 'block';
            document.getElementById('depthTitle').style.display = 'none';
            document.getElementById('conceptsWithDepth').innerHTML = '';
            document.getElementById('depthSource').textContent = '';
            
            log(`Assigning depth targets for ${extractedConcepts.length} concepts`);
            
            try {
                const response = await fetch(`${API_URL}/assign-depth-targets`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        bookName: bookName,
                        concepts: extractedConcepts
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`Server error: ${response.status}`);
                }
                
                const data = await response.json();
                log('Received depth target response', data);
                
                if (!data.conceptsWithDepth || data.conceptsWithDepth.length === 0) {
                    showError('No depth targets assigned');
                    return;
                }
                
                // Display concepts with depth
                document.getElementById('depthTitle').style.display = 'block';
                const depthContainer = document.getElementById('conceptsWithDepth');
                
                data.conceptsWithDepth.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'concept';
                    
                    const conceptSpan = document.createElement('span');
                    conceptSpan.textContent = item.concept;
                    div.appendChild(conceptSpan);
                    
                    const depthBadge = document.createElement('div');
                    depthBadge.className = 'depth-badge';
                    depthBadge.textContent = item.depth_target;
                    depthBadge.style.backgroundColor = getDepthColor(item.depth_target);
                    div.appendChild(depthBadge);
                    
                    depthContainer.appendChild(div);
                });
                
                // Show source
                document.getElementById('depthSource').textContent = `Source: ${data.source || 'unknown'}`;
                
                log(`Assigned depth targets to ${data.conceptsWithDepth.length} concepts`);
            } catch (error) {
                showError(`Error: ${error.message}`);
                log('Error assigning depth targets:', error.message);
            } finally {
                document.getElementById('loadingDepth').style.display = 'none';
            }
        });
        
        function showError(message) {
            const errorElement = document.getElementById('error');
            errorElement.textContent = message;
            errorElement.style.display = 'block';
        }
        
        // Initialize
        log('Test page loaded. Ready to extract concepts and assign depth targets.');
    </script>
</body>
</html> 